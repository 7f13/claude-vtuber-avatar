<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ãšã‚“ã ã‚‚ã‚“</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent;
      -webkit-app-region: drag;
      user-select: none;
    }

    #container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
    }

    .avatar {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: transform 0.1s ease;
      border-radius: 20px;
      position: absolute;
    }

    .avatar.talking {
      animation: bounce 0.15s ease-in-out infinite alternate;
    }

    @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-3px); }
    }

    /* å£ã®åˆ‡ã‚Šæ›¿ãˆç”¨ï¼ˆç”»åƒãŒ2æšã‚ã‚‹å ´åˆï¼‰ */
    #mouth-closed { display: block; }
    #mouth-open { display: none; position: absolute; top: 0; left: 0; }

    .talking #mouth-closed { display: none; }
    .talking #mouth-open { display: block; }

    /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆç”»åƒãŒãªã„å ´åˆï¼‰ */
    #placeholder {
      width: 200px;
      height: 300px;
      background: linear-gradient(135deg, #8BC34A 0%, #4CAF50 100%);
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: sans-serif;
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }

    #placeholder .face {
      font-size: 60px;
      margin-bottom: 10px;
    }

    #placeholder.talking .face {
      animation: talk 0.15s ease-in-out infinite alternate;
    }

    @keyframes talk {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }

    /* ã¾ã°ãŸãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes blink {
      0%, 90%, 100% { transform: scaleY(1); }
      95% { transform: scaleY(0.1); }
    }

    .avatar.blinking {
      animation: blink 0.15s ease-in-out;
    }

    /* idleæ™‚ã®æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes idle-sway {
      0%, 100% { transform: rotate(0deg) translateY(0); }
      25% { transform: rotate(0.5deg) translateY(-1px); }
      75% { transform: rotate(-0.5deg) translateY(-1px); }
    }

    .avatar.idle {
      animation: idle-sway 4s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- ç”»åƒãŒãªã„å ´åˆã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ -->
    <div id="placeholder">
      <div class="face">ğŸŸ¢</div>
      <div>ãšã‚“ã ã‚‚ã‚“</div>
      <div style="font-size: 10px; margin-top: 10px;">
        assets/zundamon.png<br>ã‚’é…ç½®ã—ã¦ã­
      </div>
    </div>

    <!-- å®Ÿéš›ã®ç”»åƒï¼ˆassetsãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®å¾Œè¡¨ç¤ºï¼‰ -->
    <!-- <img id="avatar" src="assets/zundamon.png" alt="ãšã‚“ã ã‚‚ã‚“"> -->
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const fs = require('fs');
    const path = require('path');

    const placeholder = document.getElementById('placeholder');
    const container = document.getElementById('container');

    // è¡¨æƒ…ãƒªã‚¹ãƒˆ
    const expressions = {
      normal: 'zundamon.png',
      open: 'zundamon_open.png',
      smile: 'smile.png',
      eye_sparkle: 'eye_sparkle.png',
      surprise: 'surprise.png',
      shock: 'shock.png',
      close_eye: 'close_eye.png',
    };

    let currentExpression = 'normal';
    const loadedImages = {};

    // ç”»åƒã‚’å…¨éƒ¨èª­ã¿è¾¼ã‚€
    Object.entries(expressions).forEach(([name, file]) => {
      const filePath = path.join(__dirname, 'assets', file);
      if (fs.existsSync(filePath)) {
        const img = document.createElement('img');
        img.id = `avatar-${name}`;
        img.className = 'avatar';
        img.src = `assets/${file}`;
        img.style.display = name === 'normal' ? 'block' : 'none';
        container.appendChild(img);
        loadedImages[name] = img;
      }
    });

    if (Object.keys(loadedImages).length > 0) {
      placeholder.style.display = 'none';
    }

    // è¡¨æƒ…åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
    function setExpression(name) {
      if (!loadedImages[name]) return;
      Object.entries(loadedImages).forEach(([key, img]) => {
        img.style.display = key === name ? 'block' : 'none';
      });
      currentExpression = name;
    }

    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®WebSocketæ¥ç¶š
    const ws = new WebSocket('ws://localhost:3456');

    ws.onopen = () => {
      console.log('Connected to server');
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'lipsync-start') {
        startLipsync(data.duration);
      } else if (data.type === 'lipsync-stop') {
        stopLipsync();
      } else if (data.type === 'expression') {
        setExpression(data.name);
        // ä¸€å®šæ™‚é–“å¾Œã«normalã«æˆ»ã™
        if (data.duration) {
          setTimeout(() => setExpression('normal'), data.duration);
        }
      }
    };

    ws.onerror = (error) => {
      console.log('WebSocket error:', error);
    };

    let lipsyncTimeout = null;
    let lipsyncInterval = null;

    function startLipsync(duration) {
      // å‰ã®ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã‚’åœæ­¢
      stopLipsync();

      // å£ãƒ‘ã‚¯ï¼ˆnormal ã¨ open ã‚’åˆ‡ã‚Šæ›¿ãˆï¼‰
      if (loadedImages.normal && loadedImages.open) {
        let isOpen = false;
        lipsyncInterval = setInterval(() => {
          isOpen = !isOpen;
          loadedImages.normal.style.display = isOpen ? 'none' : 'block';
          loadedImages.open.style.display = isOpen ? 'block' : 'none';
          // ä»–ã®è¡¨æƒ…ã¯éè¡¨ç¤º
          Object.entries(loadedImages).forEach(([key, img]) => {
            if (key !== 'normal' && key !== 'open') {
              img.style.display = 'none';
            }
          });
        }, 120);
      }

      // æŒ‡å®šæ™‚é–“å¾Œã«åœæ­¢
      if (duration) {
        lipsyncTimeout = setTimeout(() => {
          stopLipsync();
        }, duration);
      }
    }

    function stopLipsync() {
      if (lipsyncInterval) {
        clearInterval(lipsyncInterval);
        lipsyncInterval = null;
      }
      if (lipsyncTimeout) {
        clearTimeout(lipsyncTimeout);
        lipsyncTimeout = null;
      }
      // normalã«æˆ»ã™
      setExpression('normal');
    }

    // IPCã‹ã‚‰ã®ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯åˆ¶å¾¡
    ipcRenderer.on('lipsync-start', (event, duration) => {
      startLipsync(duration);
    });

    ipcRenderer.on('lipsync-stop', () => {
      stopLipsync();
    });

    // ========== Idle ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ==========
    let isIdle = true;
    let blinkInterval = null;

    function startIdleAnimation() {
      isIdle = true;
      // idleã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      Object.values(loadedImages).forEach(img => {
        img.classList.add('idle');
      });
      // ã¾ã°ãŸãã‚’é–‹å§‹
      startBlinking();
    }

    function stopIdleAnimation() {
      isIdle = false;
      // idleã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      Object.values(loadedImages).forEach(img => {
        img.classList.remove('idle');
        img.classList.remove('blinking');
      });
      // ã¾ã°ãŸãã‚’åœæ­¢
      if (blinkInterval) {
        clearInterval(blinkInterval);
        blinkInterval = null;
      }
    }

    function doBlink() {
      if (!isIdle) return;
      const normalImg = loadedImages.normal;
      const closeEyeImg = loadedImages.close_eye;

      if (normalImg && closeEyeImg && normalImg.style.display !== 'none') {
        // close_eyeç”»åƒã§ã¾ã°ãŸã
        normalImg.style.display = 'none';
        closeEyeImg.style.display = 'block';
        setTimeout(() => {
          closeEyeImg.style.display = 'none';
          normalImg.style.display = 'block';
        }, 100);
      } else if (normalImg && normalImg.style.display !== 'none') {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        normalImg.classList.add('blinking');
        setTimeout(() => {
          normalImg.classList.remove('blinking');
        }, 150);
      }
    }

    function startBlinking() {
      if (blinkInterval) clearInterval(blinkInterval);
      // 3ã€œ5ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ é–“éš”ã§ã¾ã°ãŸã
      function scheduleNextBlink() {
        const delay = 3000 + Math.random() * 2000;
        blinkInterval = setTimeout(() => {
          doBlink();
          if (isIdle) scheduleNextBlink();
        }, delay);
      }
      scheduleNextBlink();
    }

    // ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯æ™‚ã¯idleåœæ­¢
    const originalStartLipsync = startLipsync;
    startLipsync = function(duration) {
      stopIdleAnimation();
      originalStartLipsync(duration);
    };

    const originalStopLipsync = stopLipsync;
    stopLipsync = function() {
      originalStopLipsync();
      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰idleã«æˆ»ã‚‹
      setTimeout(() => {
        if (!lipsyncInterval) {
          startIdleAnimation();
        }
      }, 500);
    };

    // åˆæœŸåŒ–æ™‚ã«idleã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    if (Object.keys(loadedImages).length > 0) {
      startIdleAnimation();
    }
  </script>
</body>
</html>
